{% extends "layout.html" %}

{% block title %}Configuración Facturación ARCA{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Configuración Facturación ARCA</h2>

    <!-- Formulario de Configuración -->
    <div class="card shadow-sm mb-4" style="background-color: var(--card-bg);">
        <div class="card-body">
            <h4 class="card-title">Configuración de Facturación</h4>
            <form id="arcaConfigForm" method="POST" enctype="multipart/form-data">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="store_id" class="form-label">Sucursal <span class="text-danger">*</span></label>
                        <select id="store_id" name="store_id" class="form-select" required>
                            <option value="" disabled>Seleccione una sucursal</option>
                            {% if stores %}
                                {% for store in stores %}
                                    <option value="{{ store }}" {% if store == last_store %}selected{% endif %}>{{ store }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="BA001GC" selected>BA001GC (Predeterminada)</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="cuit" class="form-label">CUIT <span class="text-danger">*</span></label>
                        <input type="text" id="cuit" name="cuit" class="form-control" value="{{ config.cuit or '' }}" required placeholder="Ej: 30712345678">
                    </div>
                    <div class="col-md-3">
                        <label for="certificado" class="form-label">Certificado (.pfx) <span class="text-danger">*</span></label>
                        <input type="file" id="certificado" name="certificado" class="form-control" accept=".pfx" {% if config.certificado_data or using_static_cert %}disabled{% endif %}>
                        {% if using_static_cert %}
                            <small class="form-text text-muted">Usando certificado estático: cert/certificado.pfx</small>
                        {% elif config.certificado_data %}
                            <small class="form-text text-muted">Certificado cargado. Sube uno nuevo para reemplazar.</small>
                        {% else %}
                            <small class="form-text text-muted">Sube un archivo .pfx.</small>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <label for="clave_privada" class="form-label">Clave Privada <span class="text-danger">*</span></label>
                        <input type="password" id="clave_privada" name="clave_privada" class="form-control" value="{{ config.clave_privada or '' }}" required>
                    </div>
                    <div class="col-md-3">
                        <label for="punto_venta" class="form-label">Punto de Venta <span class="text-danger">*</span></label>
                        <input type="text" id="punto_venta" name="punto_venta" class="form-control" value="{{ config.punto_venta or '587' }}" required placeholder="Ej: 587">
                    </div>
                    <div class="col-md-3">
                        <label for="ambiente" class="form-label">Ambiente <span class="text-danger">*</span></label>
                        <select id="ambiente" name="ambiente" class="form-select" required>
                            <option value="" disabled {% if not config.ambiente %}selected{% endif %}>Seleccione...</option>
                            <option value="homologacion" {% if config.ambiente == 'homologacion' %}selected{% endif %}>Homologación</option>
                            <option value="produccion" {% if config.ambiente == 'produccion' %}selected{% endif %}>Producción</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="modo_autorizacion" class="form-label">Modo de Autorización <span class="text-danger">*</span></label>
                        <select id="modo_autorizacion" name="modo_autorizacion" class="form-select" required>
                            <option value="" disabled {% if not config.modo_autorizacion %}selected{% endif %}>Seleccione...</option>
                            <option value="CAE" {% if config.modo_autorizacion == 'CAE' %}selected{% endif %}>CAE</option>
                            <option value="CAEA" {% if config.modo_autorizacion == 'CAEA' %}selected{% endif %}>CAEA</option>
                        </select>
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-secondary rounded-pill me-2" onclick="limpiarFormulario('arcaConfigForm')">Limpiar</button>
                    <button type="submit" class="btn btn-primary rounded-pill">Guardar Configuración</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Formulario de Prueba de Facturación -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5>Prueba de Facturación</h5>
        </div>
        <div class="card-body">
            <form id="arcaTestForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="test_store_id" class="form-label">Sucursal <span class="text-danger">*</span></label>
                        <select id="test_store_id" name="store_id" class="form-select" required>
                            <option value="" disabled>Seleccione una sucursal</option>
                            {% if stores %}
                                {% for store in stores %}
                                    <option value="{{ store }}" {% if store == last_store %}selected{% endif %}>{{ store }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="BA001GC" selected>BA001GC (Predeterminada)</option>
                            {% endif %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="tipo_cbte" class="form-label">Tipo Comprobante <span class="text-danger">*</span></label>
                        <select id="tipo_cbte" name="tipo_cbte" class="form-select" required>
                            <option value="6" selected>Factura B (6)</option>
                            <option value="1">Factura A (1)</option>
                            <option value="2">Nota de Crédito A (2)</option>
                            <option value="7">Nota de Crédito B (7)</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="punto_vta" class="form-label">Punto de Venta <span class="text-danger">*</span></label>
                        <input type="text" id="punto_vta" name="punto_vta" class="form-control" value="{{ config.punto_venta or '587' }}" required placeholder="Ej: 587">
                    </div>
                    <div class="col-md-3">
                        <label for="imp_total" class="form-label">Importe Total <span class="text-danger">*</span></label>
                        <input type="number" id="imp_total" name="imp_total" class="form-control" value="1210.00" step="0.01" required placeholder="Ej: 1210.00">
                    </div>
                    <div class="col-md-3">
                        <label for="doc_nro" class="form-label">CUIT Receptor <span class="text-danger">*</span></label>
                        <input type="text" id="doc_nro" name="doc_nro" class="form-control" value="95981592" required placeholder="Ej: 3070892301">
                    </div>
                    <div class="col-md-3">
                        <label for="concepto" class="form-label">Concepto <span class="text-danger">*</span></label>
                        <input type="number" id="concepto" name="concepto" class="form-control" value="1" required placeholder="Ej: 1 (Productos)">
                    </div>
                    <div class="col-md-3">
                        <label for="imp_neto" class="form-label">Importe Neto <span class="text-danger">*</span></label>
                        <input type="number" id="imp_neto" name="imp_neto" class="form-control" value="1000.00" step="0.01" required placeholder="Ej: 1000.00">
                    </div>
                    <div class="col-md-3">
                        <label for="iva_pct" class="form-label">IVA % <span class="text-danger">*</span></label>
                        <input type="number" id="iva_pct" name="iva_pct" class="form-control" value="21" step="0.01" required placeholder="Ej: 21">
                    </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-secondary rounded-pill me-2" onclick="limpiarFormulario('arcaTestForm')">Limpiar</button>
                    <button type="submit" class="btn btn-success rounded-pill">Enviar Factura de Prueba</button>
                </div>
            </form>
            <div id="facturaResponse" class="mt-3 alert alert-info d-none"></div>
        </div>
    </div>

    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5>Flujos de Facturación</h5>
        </div>
        <div class="card-body">
            <a href="{{ url_for('modulo_facturacion_arca.factura_form') }}" class="btn btn-primary me-2">Factura</a>
            <a href="{{ url_for('modulo_facturacion_arca.nota_credito') }}" class="btn btn-warning me-2">Nota de Crédito</a>
            <a href="{{ url_for('modulo_facturacion_arca.acopio') }}" class="btn btn-secondary">Acopio</a>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
const backendStores = {{ stores | tojson | safe }};
const lastStore = {{ last_store | tojson | safe }};

function limpiarFormulario(formId) {
    console.log(`Limpiando formulario ${formId}`);
    const form = document.getElementById(formId);
    form.reset();
    if (formId === 'arcaConfigForm') {
        document.getElementById('store_id').value = lastStore || 'BA001HE';
        document.getElementById('ambiente').value = '';
        document.getElementById('modo_autorizacion').value = '';
    } else if (formId === 'arcaTestForm') {
        document.getElementById('test_store_id').value = lastStore || 'BA001HE';
        document.getElementById('tipo_cbte').value = '6';
        document.getElementById('punto_vta').value = '{{ config.punto_venta or "587" }}';
        document.getElementById('imp_total').value = '1210.00';
        document.getElementById('doc_nro').value = '95981592';
        document.getElementById('concepto').value = '1';
        document.getElementById('imp_neto').value = '1000.00';
        document.getElementById('iva_pct').value = '21';
    }
}

document.getElementById('arcaConfigForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('Formulario de configuración enviado');
    const formData = new FormData(e.target);
    const requiredFields = ['store_id', 'cuit', 'clave_privada', 'punto_venta', 'ambiente', 'modo_autorizacion'];
    for (const field of requiredFields) {
        if (!formData.get(field)) {
            showToast('danger', `El campo ${field} es requerido`);
            return;
        }
    }
    if (backendStores.length && !backendStores.includes(formData.get('store_id'))) {
        showToast('danger', 'Sucursal inválida');
        return;
    }
    try {
        const response = await fetchWithAuth('/modulo_facturacion_arca/config', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (result.message) {
            showToast('success', result.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast('danger', result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al guardar configuración:', error);
        showToast('danger', error.message || 'Error en la conexión');
    }
});

document.getElementById('arcaTestForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    console.log('Formulario de prueba enviado');
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    console.debug('Datos enviados:', data);
    const responseDiv = document.getElementById('facturaResponse');
    responseDiv.classList.add('d-none');
    const requiredFields = ['store_id', 'tipo_cbte', 'punto_venta', 'imp_total', 'doc_nro', 'concepto', 'imp_neto', 'iva_pct'];
    for (const field of requiredFields) {
        if (!data[field]) {
            showToast('danger', `El campo ${field} es requerido`);
            return;
        }
    }
    if (backendStores.length && !backendStores.includes(data.store_id)) {
        showToast('danger', 'Sucursal inválida');
        return;
    }
    try {
        const response = await fetchWithAuth('/modulo_facturacion_arca/facturar', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.autorizacion) {
            responseDiv.classList.remove('d-none', 'alert-danger');
            responseDiv.classList.add('alert-success');
            responseDiv.innerHTML = `<strong>Éxito:</strong> Autorización: ${result.autorizacion}<br>Comprobante: ${String(result.punto_vta).padStart(4, '0')}-${String(result.nro_cbte).padStart(8, '0')}<br>${result.message}`;
            showToast('success', result.message);
        } else {
            responseDiv.classList.remove('d-none', 'alert-success');
            responseDiv.classList.add('alert-danger');
            responseDiv.innerHTML = `<strong>Error:</strong> ${result.error || 'Error desconocido'}`;
            showToast('danger', result.error || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error al enviar factura de prueba:', error);
        responseDiv.classList.remove('d-none', 'alert-success');
        responseDiv.classList.add('alert-danger');
        responseDiv.innerHTML = `<strong>Error:</strong> ${error.message || 'Error en la conexión'}`;
        showToast('danger', error.message || 'Error en la conexión');
    }
});
</script>
{% endblock %}