{% extends 'layout.html' %}
{% block title %}Presupuestos{% endblock %}
{% block content %}
<div class="container">
  <h1 class="mb-4">Gestión de Presupuestos</h1>

  <div class="mb-4">
    <label for="searchTerm" class="form-label">Buscar producto por SKU o descripción</label>
    <div class="input-group">
      <input id="searchTerm" type="text" class="form-control" placeholder="SKU o descripción">
      <button id="searchBtn" class="btn btn-primary" type="button">Buscar</button>
    </div>
    <ul id="searchResults" class="list-group mt-2"></ul>
  </div>

  <div class="mb-4">
    <button id="saveCartBtn" class="btn btn-success me-2" type="button">Guardar Carrito</button>
    <button id="restoreCartBtn" class="btn btn-secondary" type="button">Restaurar Carrito</button>
  </div>

  <div>
    <h5>Números de presupuesto guardados</h5>
    <ul id="quotationList" class="list-group"></ul>
  </div>
</div>

<script>
  async function cargarPresupuestos() {
    try {
      const res = await fetch('/api/quotation_numbers');
      const data = await res.json();
      const list = document.getElementById('quotationList');
      list.innerHTML = '';
      data.forEach(p => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = p.numero;
        list.appendChild(li);
      });
    } catch (err) {
      console.error('Error cargando presupuestos:', err);
    }
  }

  document.getElementById('searchBtn').addEventListener('click', async () => {
    const term = document.getElementById('searchTerm').value;
    const res = await fetch(`/api/search_products_index?q=${encodeURIComponent(term)}`);
    const data = await res.json();
    const list = document.getElementById('searchResults');
    list.innerHTML = '';
    data.forEach(p => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `${p.sku} - ${p.descripcion}`;
      list.appendChild(li);
    });
  });

  document.getElementById('saveCartBtn').addEventListener('click', async () => {
    const cart = JSON.parse(localStorage.getItem('cart') || '{}');
    const timestamp = new Date().toISOString();
    await fetch('/api/save_user_cart', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: '{{ session.get('email') }}', cart, timestamp })
    });
    alert('Carrito guardado');
  });

  document.getElementById('restoreCartBtn').addEventListener('click', async () => {
    const res = await fetch('/api/get_user_cart');
    const data = await res.json();
    localStorage.setItem('cart', JSON.stringify(data));
    alert('Carrito restaurado');
  });

  cargarPresupuestos();
{% extends "layout.html" %}

{% block title %}Presupuestos{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Gestión de Presupuestos</h2>
  <div class="mb-3">
    <label for="quotationSearch" class="form-label">Buscar Presupuesto</label>
    <input id="quotationSearch" class="form-control" placeholder="ID de presupuesto">
    <button class="btn btn-primary mt-2" onclick="buscarPresupuesto()">Buscar</button>
  </div>
  <div class="mb-3">
    <button class="btn btn-success" onclick="guardarCarrito()">Guardar Carrito</button>
    <button class="btn btn-secondary" onclick="restaurarCarrito()">Restaurar Carrito</button>
    <button class="btn btn-outline-info" onclick="listarPresupuestos()">Ver Presupuestos Guardados</button>
  </div>
  <ul id="listaPresupuestos" class="mb-3"></ul>
  <pre id="quotationResult" class="bg-light p-3"></pre>
</div>

<script>
async function buscarPresupuesto() {
  const id = document.getElementById('quotationSearch').value;
  if(!id) return;
  const res = await fetch(`/api/d365_quotation/${id}`);
  const data = await res.json();
  document.getElementById('quotationResult').textContent = JSON.stringify(data, null, 2);
}

async function guardarCarrito() {
  const cart = window.cart || {};
  const res = await fetch('/api/save_cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cart, timestamp: Date.now() })
  });
  const data = await res.json();
  alert(data.message || data.error);
}

async function restaurarCarrito() {
  const res = await fetch('/api/get_user_cart');
  const data = await res.json();
  document.getElementById('quotationResult').textContent = JSON.stringify(data, null, 2);
}

async function listarPresupuestos(){
  const res = await fetch('/api/quotations');
  const data = await res.json();
  const ul = document.getElementById('listaPresupuestos');
  ul.innerHTML = '';
  data.forEach(q => {
    const li = document.createElement('li');
    li.textContent = q.id;
    ul.appendChild(li);
  });
}
</script>
{% endblock %}
