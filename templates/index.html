{% extends "layout.html" %}

{% block title %}Búsqueda de Productos{% endblock %}

{% block content %}
<!-- Contenedor para el botón de toggle de la sidebar -->
<button class="btn btn-secondary cart-float-btn" onclick="toggleCart()">
  <i class="bi bi-cart"></i> (<span id="cartItemCount">0</span>) | $ <span id="cartTotalFloat" class="mono">0,00</span> | <span id="cartClientFloat">Sin cliente</span>
</button>
<div class="container-fluid d-flex">
  <!-- Sidebar (Filtros) -->
  <div class="sidebar">
    <div class="filters-container">
      <div class="mb-3">
        <label for="storeFilter" class="form-label">Sucursal</label>
        <select id="storeFilter" class="form-select">
          {% for store in stores %}
            <option value="{{ store }}">{{ store }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="excludeSpecialCategories" checked>
        <label class="form-check-label" for="excludeSpecialCategories">Excluir categorías especiales</label>
      </div>
      <details class="mb-3">
        <summary>Precios</summary>
        <div class="mt-2">
          <label class="form-label">Rango de Precio</label>
          <select id="priceRangeFilter" class="form-select" onchange="actualizarFiltrosPrecio()">
            <option value="">Todos</option>
            <option value="0-250000">0 - 250,000</option>
            <option value="250001-800000">250,001 - 800,000</option>
            <option value="800001-999999999">800,001+</option>
          </select>
          <div class="mt-2 d-flex gap-2">
            <input type="number" id="minPrice" class="form-control" placeholder="Min" min="0" oninput="actualizarFiltrosPrecio()">
            <input type="number" id="maxPrice" class="form-control" placeholder="Max" min="0" oninput="actualizarFiltrosPrecio()">
          </div>
        </div>
      </details>
      <details class="mb-3">
        <summary>Stock</summary>
        <div class="mt-2 d-flex flex-column gap-2">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="signoMas" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="signoMas">Stock positivo</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="signoMenos" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="signoMenos">Stock negativo</label>
          </div>
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="cero" checked onchange="filterAndPaginate(false)">
            <label class="form-check-label" for="cero">Stock cero</label>
          </div>
        </div>
      </details>
      <details class="mb-3">
        <summary>Categorías</summary>
        <div class="mt-2">
          <label for="categoryFilter" class="form-label">Categoría</label>
          <select id="categoryFilter" class="form-select">
            <option value="">Todos</option>
          </select>
          <label for="coverageGroupFilter" class="form-label mt-2">Grupo de Cobertura</label>
          <select id="coverageGroupFilter" class="form-select">
            <option value="">Todos</option>
          </select>
        </div>
      </details>
      <button class="btn btn-secondary w-100 clear-filters-btn" onclick="clearFilters()">Limpiar Filtros</button>
    </div>
  </div>

  <div class="main-content flex-grow-1">
    <!-- Search Bar -->
    <div class="search-floating">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="openClientSearchModal()">
          <i class="bi bi-person"></i>
        </button>
        <!-- Botón para escanear QR/Código de barras -->
        <button class="btn btn-outline-primary btn-sm" onclick="openScannerModal()">
          <i class="bi bi-qr-code-scan"></i>
        </button>
        <div class="search-box">
          <i class="bi bi-search search-icon"></i>
          <input type="text" id="search" class="form-control" placeholder="Buscar productos..." />
        </div>
      </div>
    </div>

    <!-- Spinner -->
    <div id="spinner" class="spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
    </div>

    <!-- View Selector -->
    <div class="view-selector d-flex justify-content-end mb-3">
       <button id="sidebarToggleBtn" class="btn btn-outline-primary">
        <i class="bi bi-list"></i> Filtros
       </button>
      <button class="btn btn-outline-primary me-2" id="btnTableView" onclick="cambiarVista('tabla')">
        <i class="bi bi-table"></i>
      </button>
      <button class="btn btn-outline-primary" id="btnCardView" onclick="cambiarVista('cards')">
        <i class="bi bi-grid"></i>
      </button>
    </div>

    <!-- Table View -->
    <div id="tableView" class="table-responsive">
      <table class="table table-striped table-hover" id="productTable">
        <thead>
          <tr>
            <th onclick="sortTable(0)">SKU</th>
            <th onclick="sortTable(1)">Categoría</th>
            <th onclick="sortTable(2)">Nombre</th>
            <th onclick="sortTable(3)">Grupo Cobertura</th>
            <th onclick="sortTable(4)">U.M.</th>
            <th onclick="sortTable(5)">Precio IVA</th>
            <th onclick="sortTable(6)">Precio Desc.</th>
            <th onclick="sortTable(7)">Sucursal</th>
            <th>Imagen</th>
            <th>Stock</th>
            <th>Carrito</th>
          </tr>
        </thead>
        <tbody id="productList"></tbody>
      </table>
    </div>

    <!-- Card View -->
    <div id="cardView" class="d-none row row-cols-1 row-cols-md-3 row-cols-lg-5 g-3"></div>

    <!-- Pagination -->
    <div id="pagination" class="d-flex justify-content-center mt-4"></div>
  </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
  <div class="image-modal-content">
    <button class="close-modal" onclick="closeModal()">×</button>
    <img id="modalImage" src="{{ url_for('serve_image', filename='default.jpg') }}" alt="Producto">
  </div>
</div>

<!-- Quantity Modal -->
<div id="quantityModal" class="modal fade quantity-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title"><i class="bi bi-cart-plus me-2"></i> Agregar al Carrito</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="product-name mb-1" id="quantityModalProductName"></p>
        <p class="price-info mb-3">Precio: <span id="quantityModalProductPrice" class="fw-bold text-success"></span></p>
        <div class="quantity-input-group">
          <label for="quantityInput" class="form-label">Cantidad:</label>
          <div class="input-group">
            <button class="btn btn-outline-secondary" onclick="adjustQuantity(-1)"><i class="bi bi-dash"></i></button>
            <input type="number" id="quantityInput" class="form-control text-center" min="1" value="1" onchange="updateTotal()">
            <span class="input-group-text" id="quantityModalUnitMeasure"></span>
            <button class="btn btn-outline-secondary" onclick="adjustQuantity(1)"><i class="bi bi-plus"></i></button>
          </div>
          <p id="quantityModalCajas" class="equivalencia-texto mt-2"></p>
        </div>
        <p class="total-info mt-3">Total: <span id="quantityModalTotal" class="fw-bold text-primary"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="addToCartConfirmed()">Agregar</button>
      </div>
    </div>
  </div>
</div>

<!-- Stock Overlay -->
<div id="stockOverlay" class="stock-modal d-none">
  <div class="stock-overlay-content">
    <button class="stock-close-overlay" onclick="cerrarOverlaystock()">×</button>
    <div class="stock-header">
      <h4 id="stockProductoNombre"></h4>
      <p class="stock-subtitle">SKU: <span id="stockProductoCodigo"></span> | Unidad: <span id="stockProductoUnidad"></span></p>
    </div>
    <div class="stock-table-container">
      <table class="table table-striped table-hover stock-table">
        <thead>
          <tr>
            <th>Almacén</th>
            <th>Disponible Venta</th>
            <th>Disponible Entrega</th>
            <th>Comprometido</th>
          </tr>
        </thead>
        <tbody id="stockTabla"></tbody>
        <tfoot>
          <tr>
            <th>Total</th>
            <th id="totalVenta">0,00</th>
            <th id="totalEntrega">0,00</th>
            <th id="totalComprometido">0,00</th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<!-- WhatsApp Floating Button -->
<button class="whatsapp-btn" id="whatsappBtn" title="Enviar mensaje por WhatsApp">
  <i class="fa fa-whatsapp"></i>
</button>

<!-- Modal para agregar nuevo cliente -->
<div id="addClientModal" class="modal fade client-modal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addClientModalLabel"><i class="bi bi-person-plus me-2"></i> Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <form id="addClientForm">
          <div class="row g-4">
            <!-- Información Personal -->
            <div class="col-12 col-md-6">
              <div class="client-section p-4 rounded shadow-sm">
                <h6 class="mb-3"><i class="bi bi-person-fill me-2"></i>Información Personal</h6>
                <div class="row mb-3">
                  <label for="newClientDni" class="col-12 col-sm-4 col-form-label fw-medium">DNI <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientDni" required onblur="validateDni()">
                    <small id="dniValidationMessage" class="text-danger d-block mt-1"></small>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientName" class="col-12 col-sm-4 col-form-label fw-medium">Nombre <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientName" required disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientLastName" class="col-12 col-sm-4 col-form-label fw-medium">Apellido <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientLastName" required disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientEmail" class="col-12 col-sm-4 col-form-label fw-medium">Email</label>
                  <div class="col-12 col-sm-8">
                    <input type="email" class="form-control" id="newClientEmail" required disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientPhone" class="col-12 col-sm-4 col-form-label fw-medium">Teléfono</label>
                  <div class="col-12 col-sm-8">
                    <input type="tel" class="form-control" id="newClientPhone" required disabled>
                  </div>
                </div>
              </div>
            </div>
            <!-- Dirección -->
            <div class="col-12 col-md-6">
              <div class="client-section p-4 rounded shadow-sm">
                <h6 class="mb-3"><i class="bi bi-geo-alt-fill me-2"></i>Dirección</h6>
                <div class="row mb-3">
                  <label for="newClientZipCode" class="col-12 col-sm-4 col-form-label fw-medium">Código Postal <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientZipCode" required disabled onblur="loadPostalCodeData()">
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientCitySelect" class="col-12 col-sm-4 col-form-label fw-medium">Ciudad <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <select class="form-select" id="newClientCitySelect" required disabled onchange="fillAddressFields()">
                      <option value="">Seleccione una ciudad</option>
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientStreet" class="col-12 col-sm-4 col-form-label fw-medium">Calle <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientStreet" required disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientStreetNumber" class="col-12 col-sm-4 col-form-label fw-medium">Altura <span class="text-danger">*</span></label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientStreetNumber" required disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientReference" class="col-12 col-sm-4 col-form-label fw-medium">Referencia</label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientReference" disabled>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientLatitude" class="col-12 col-sm-4 col-form-label fw-medium">Latitud</label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientLatitude" readonly>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="newClientLongitude" class="col-12 col-sm-4 col-form-label fw-medium">Longitud</label>
                  <div class="col-12 col-sm-8">
                    <input type="text" class="form-control" id="newClientLongitude" readonly>
                  </div>
                </div>
              </div>
            </div>
            <!-- Mapa -->
            <div class="col-12">
              <div class="client-section p-4 rounded shadow-sm">
                <h6 class="mb-3"><i class="bi bi-map me-2"></i>Ubicación en el Mapa</h6>
                <div id="map" class="map-container w-100 rounded shadow-sm" style="height: 300px; position: relative;"></div>
                <div id="geocodeAddressDisplay" class="mt-3 text-muted" style="font-size: 0.85rem; word-wrap: break-word;"></div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success rounded-pill" onclick="saveNewClient()" disabled id="saveClientBtn">Guardar Cliente</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para escanear QR/Código de barras -->
<div id="scannerModal" class="modal fade scanner-modal" tabindex="-1" aria-labelledby="scannerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="scannerModalLabel"><i class="bi bi-qr-code-scan me-2"></i> Escanear Código</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="stopScanner()"></button>
      </div>
      <div class="modal-body text-center p-4">
        <div class="scanner-video-container">
          <video id="scannerVideo" width="100%" height="auto" autoplay playsinline></video>
          <div class="scanner-frame"></div>
        </div>
        <p id="scannerStatus" class="scanner-status mt-3">Apunta la cámara al código QR o de barras</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal" onclick="stopScanner()">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  const backendStores = {{ stores | tojson }};
  const lastStore = {{ last_store | tojson }};
  document.addEventListener("DOMContentLoaded", function () {
    loadProducts(lastStore || 'BA001GC');
    // Asegurar que la sidebar esté oculta al cargar en pantallas pequeñas
    if (window.innerWidth < 1200) {
      document.querySelector('.sidebar').classList.remove('active');
    }
  });

  // Toggle de la sidebar
  document.getElementById('sidebarToggleBtn').addEventListener('click', function () {
    document.querySelector('.sidebar').classList.toggle('active');
  });

  // Cerrar la sidebar al hacer clic fuera de ella en pantallas pequeñas
  document.addEventListener('click', function (event) {
    const sidebar = document.querySelector('.sidebar');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    if (window.innerWidth < 1200 && sidebar.classList.contains('active')) {
      if (!sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
        sidebar.classList.remove('active');
      }
    }
  });
</script>
{% endblock %}

